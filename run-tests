#!/bin/bash
# run-tests
#
# Run before releasing to PyPI. Starts server, runs tests, reports results.
# Exit 0 = safe to release
#
# Usage:
#   ./run-tests
#   ./run-tests --rebuild   # Force rebuild venv

set -e
cd "$(dirname "$0")"

PORT=5099
SERVER_PID=""
VENV_DIR=".venv-test"
REBUILD=false

# Required packages (name:minimum_version)
REQUIRED_PKGS="playwright:1.40.0"

[ "$1" = "--rebuild" ] && REBUILD=true

cleanup() {
    [ -n "$SERVER_PID" ] && kill $SERVER_PID 2>/dev/null || true
}
trap cleanup EXIT

echo "═══════════════════════════════════════════════"
echo "  NUTRITION-PAD PRE-RELEASE TESTS"
echo "═══════════════════════════════════════════════"

# Version
VERSION=$(grep -E '^version' pyproject.toml | sed 's/.*"\(.*\)"/\1/')
echo "Version: $VERSION"
echo ""

# Check if package is installed with minimum version
# Returns 0 if ok, 1 if missing or too old
check_pkg() {
    local pkg="$1"
    local min_ver="$2"
    
    installed_ver=$(pip show "$pkg" 2>/dev/null | grep "^Version:" | cut -d' ' -f2)
    
    if [ -z "$installed_ver" ]; then
        echo "  ✗ $pkg: not installed"
        return 1
    fi
    
    # Compare versions (works for most semver)
    if printf '%s\n%s\n' "$min_ver" "$installed_ver" | sort -V | head -n1 | grep -q "^$min_ver$"; then
        echo "  ✓ $pkg: $installed_ver"
        return 0
    else
        echo "  ✗ $pkg: $installed_ver (need >= $min_ver)"
        return 1
    fi
}

check_deps() {
    [ -d "$VENV_DIR" ] || return 1
    source "$VENV_DIR/bin/activate"
    
    echo "▶ Checking dependencies..."
    
    local failed=0
    
    for pkgspec in $REQUIRED_PKGS; do
        pkg="${pkgspec%%:*}"
        min_ver="${pkgspec##*:}"
        check_pkg "$pkg" "$min_ver" || failed=1
    done
    
    # Check nutrition-pad is installed (editable)
    if pip show nutrition-pad > /dev/null 2>&1; then
        np_ver=$(pip show nutrition-pad | grep "^Version:" | cut -d' ' -f2)
        echo "  ✓ nutrition-pad: $np_ver (editable)"
    else
        echo "  ✗ nutrition-pad: not installed"
        failed=1
    fi
    
    # Check chromium
    if ls "$HOME/.cache/ms-playwright/chromium-"* > /dev/null 2>&1; then
        chromium_dir=$(ls -d "$HOME/.cache/ms-playwright/chromium-"* | head -1)
        echo "  ✓ chromium: $(basename "$chromium_dir")"
    else
        echo "  ✗ chromium: not installed"
        failed=1
    fi
    
    echo ""
    return $failed
}

setup_venv() {
    echo "▶ Setting up test venv..."
    rm -rf "$VENV_DIR"
    python3 -m venv "$VENV_DIR"
    source "$VENV_DIR/bin/activate"
    pip install --upgrade pip -q
    echo "  Installing playwright..."
    pip install playwright -q
    echo "  Installing chromium..."
    playwright install chromium
    echo "  Installing nutrition-pad..."
    pip install -e . -q
    echo "  ✓ Venv ready"
    echo ""
}

if [ "$REBUILD" = true ]; then
    setup_venv
elif ! check_deps; then
    echo "▶ Dependencies missing or outdated, rebuilding..."
    setup_venv
fi

# Syntax check
echo "▶ Syntax check..."
python3 -m py_compile nutrition_pad/*.py && echo "  ✓ OK" || exit 1

# Start server
echo "▶ Starting server..."
python3 -c "
from nutrition_pad.main import app
app.run(host='127.0.0.1', port=$PORT, debug=False, use_reloader=False)
" > /tmp/server.log 2>&1 &
SERVER_PID=$!

for i in {1..20}; do
    curl -s "http://127.0.0.1:$PORT/" > /dev/null && break
    sleep 0.3
done

if ! curl -s "http://127.0.0.1:$PORT/" > /dev/null; then
    echo "  ❌ Server failed to start"
    cat /tmp/server.log
    exit 1
fi
echo "  ✓ Server running"

# Run tests
echo "▶ Running tests..."
echo ""
python3 tests/slider_propagation.py "http://127.0.0.1:$PORT"
RESULT=$?

echo ""
echo "═══════════════════════════════════════════════"
if [ $RESULT -eq 0 ]; then
    echo "  ✅ READY TO RELEASE v$VERSION"
    echo ""
    echo "  python3 -m build && twine upload dist/*"
else
    echo "  ❌ FIX TESTS BEFORE RELEASE"
fi
echo "═══════════════════════════════════════════════"
exit $RESULT
