#!/bin/bash
# Run all tests locally: starts a test server, runs tests, cleans up.
set -o errexit
set -o nounset
set -o pipefail

TEST_PORT=5099
SERVER_PID=""
VENV_DIR=".venv-release"

cleanup() {
    [ -n "$SERVER_PID" ] && kill $SERVER_PID 2>/dev/null || true
}
trap cleanup EXIT

# Activate venv
if [ ! -d "$VENV_DIR" ]; then
    echo "No venv found. Run ./release first to set it up."
    exit 1
fi
source "$VENV_DIR/bin/activate"
pip install -e . -q 2>/dev/null

echo "═══════════════════════════════════════════════"
echo "  LOCAL TEST RUN"
echo "═══════════════════════════════════════════════"

# Start test server
echo "▶ Starting test server on port $TEST_PORT..."
cd /tmp
python3 -c "
from nutrition_pad.main import app
app.run(host='127.0.0.1', port=$TEST_PORT, debug=False, use_reloader=False)
" > /tmp/test-server.log 2>&1 &
SERVER_PID=$!
cd - > /dev/null

for i in {1..20}; do
    curl -s "http://127.0.0.1:$TEST_PORT/" > /dev/null 2>&1 && break
    sleep 0.3
done

if ! curl -s "http://127.0.0.1:$TEST_PORT/" > /dev/null 2>&1; then
    echo "  ❌ Test server failed to start"
    cat /tmp/test-server.log
    exit 1
fi
echo "  ✓ Server running"

# Playwright tests
if [ -f tests/slider_propagation.py ]; then
    echo "▶ Slider propagation test..."
    python3 tests/slider_propagation.py "http://127.0.0.1:$TEST_PORT"
fi

if [ -f tests/test_dashboard_refresh.py ]; then
    echo "▶ Dashboard refresh test..."
    python3 tests/test_dashboard_refresh.py "http://127.0.0.1:$TEST_PORT"
fi

# CLI tests (server still running)
echo "▶ CLI tests..."
python3 tests/test_nutrition_food_cli.py
python3 tests/test_nutrition_unknown_cli.py
python3 tests/test_api_routes.py
python3 tests/test_entries_api.py

# Integration tests against running server
if [ -f tests/test_backdate_entry.py ]; then
    echo "▶ Backdate entry test..."
    python3 tests/test_backdate_entry.py
fi

echo ""
echo "═══════════════════════════════════════════════"
echo "  ALL TESTS PASSED ✅"
echo "═══════════════════════════════════════════════"
