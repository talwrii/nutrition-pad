#!/bin/bash
cd "$(dirname "$0")"
cleanup() {
    echo "Shutting down..."
    adb emu kill 2>/dev/null
    kill $EMU_PID 2>/dev/null
    kill $SERVER_PID 2>/dev/null
    rm -r daily_logs
}
trap cleanup EXIT

cp foods-orig.toml foods.toml

# Start emulator
android-emulator -no-window -no-audio -avd nexus10 -wipe-data &
EMU_PID=$!

adb wait-for-device
adb shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done'
sleep 5

# Start nutrition-pad
nutrition-pad --host 127.0.0.1 --port 5001 &
SERVER_PID=$!
sleep 5

adb shell am start -a android.intent.action.VIEW -d "http://10.0.2.2:5001/?pad=proteins"
sleep 5

# Rotate to portrait mode (1 = portrait, 90 degrees CCW)
adb shell content insert --uri content://settings/system --bind name:s:user_rotation --bind value:i:1
adb shell content insert --uri content://settings/system --bind name:s:accelerometer_rotation --bind value:i:0
sleep 3

# Force a screen refresh by toggling airplane mode or sending a broadcast
adb shell am broadcast -a android.intent.action.CONFIGURATION_CHANGED
sleep 15

adb exec-out screencap -p > nutrition_nexus10.png
echo "Done: nutrition_nexus10.png"

